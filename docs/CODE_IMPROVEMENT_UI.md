# Документация по интерфейсу улучшения кода в Telegram-боте

## Обзор

`CodeImproverUI` - это модуль, обеспечивающий взаимодействие пользователей Telegram-бота с агентом улучшения кода. Модуль предоставляет интерфейс для анализа, предложения улучшений и применения исправлений к коду, отправленному пользователем через Telegram.

## Архитектура

Модуль построен по принципу микросервисной архитектуры и интегрируется с существующей системой через следующие компоненты:

1. **CodeImproverUI** - основной класс, обрабатывающий запросы от пользователей Telegram
2. **CodeImprovementAgent** - агент для анализа и улучшения кода
3. **ModelServiceClient** - адаптер для взаимодействия с моделью Mistral

```
┌─────────────────┐      ┌──────────────────────┐      ┌───────────────────┐
│                 │      │                      │      │                   │
│  Telegram Bot   │─────▶│   CodeImproverUI     │─────▶│CodeImprovementAgent│
│                 │      │                      │      │                   │
└─────────────────┘      └──────────────────────┘      └───────────────────┘
                                   │                            │
                                   │                            │
                                   ▼                            ▼
                         ┌──────────────────┐        ┌────────────────────┐
                         │                  │        │                    │
                         │ ModelServiceClient│───────▶│   Mistral API     │
                         │                  │        │   139.59.241.176:8080│
                         └──────────────────┘        └────────────────────┘
```

## Функциональность

### Команды для пользователей

Модуль добавляет следующие команды для пользователей Telegram-бота:

1. `/analyze` - анализирует код без внесения изменений
2. `/suggest` - предлагает улучшения для ранее проанализированного кода
3. `/improve` - анализирует и улучшает код одним действием
4. `/diff` - показывает разницу между оригинальным и улучшенным кодом

### Формат взаимодействия

Для отправки кода необходимо использовать формат с тройными обратными кавычками и указанием языка программирования:

```
/analyze ```python
def example():
    print("Hello, World!")
```

Или без указания языка (по умолчанию будет использован Python):

```
/improve ```
def example():
    print("Hello, World!")
```
```

### Интерактивные элементы

После анализа кода пользователю предоставляются интерактивные кнопки для выполнения следующих действий:

1. После команды `/analyze` - кнопка "Предложить улучшения"
2. После команды `/suggest` - кнопка "Применить улучшения"

## Интеграция с системой

### Инициализация

Для интеграции модуля с существующим Telegram-ботом необходимо:

1. Импортировать класс `CodeImproverUI` из модуля `telegram_bot.code_improver_ui`
2. Создать экземпляр `CodeImproverUI` с адаптером модели и конфигурацией
3. Зарегистрировать обработчики команд и колбэков

Пример инициализации:

```python
from telegram_bot.code_improver_ui import CodeImproverUI
from telegram_bot.model_service_client import ModelServiceClient

# Создаем адаптер модели
model_adapter = ModelServiceClient(config={
    "MODEL_NAME": "mistral-small",
    "MISTRAL_API_URL": "http://139.59.241.176:8080"
})

# Создаем экземпляр интерфейса улучшения кода
code_improver_ui = CodeImproverUI(
    model_adapter=model_adapter,
    config={"agent_config": {"temperature": 0.7, "max_context_length": 8000}}
)

# Регистрируем обработчики команд
application.add_handler(CommandHandler("analyze", analyze_code))
application.add_handler(CommandHandler("suggest", suggest_improvements))
application.add_handler(CommandHandler("improve", improve_code))
application.add_handler(CommandHandler("diff", show_diff))
application.add_handler(CallbackQueryHandler(handle_callback_query))
```

### Зависимости

Для работы модуля необходимы следующие компоненты:

1. `python-telegram-bot` версии 20.0 или выше
2. `src.agents.code_improvement_agent` - модуль агента улучшения кода
3. `src.agents.code_analyzer` - модуль анализатора кода
4. `src.agents.code_transformer` - модуль трансформатора кода
5. Доступ к Mistral API через HTTP

## Примеры использования

### Анализ кода

```
/analyze ```python
def calculate_factorial(n):
    result = 1
    for i in range(1, n + 1):
        result *= i
    return result
```
```

Результат:
```
📊 Результаты анализа кода на языке python:

🔍 Метрики кода:
- Оценка сложности: 3.50/10
- Индекс поддерживаемости: 75.20/100

⚠️ Выявленные проблемы (1):
1. Отсутствует проверка на отрицательные значения n

💡 Предложения по улучшению (2):
1. Добавить валидацию входных данных
2. Добавить документацию к функции
```

### Улучшение кода

```
/improve ```python
def calculate_factorial(n):
    result = 1
    for i in range(1, n + 1):
        result *= i
    return result
```
```

Результат:
```
✅ Код успешно улучшен!

Было выявлено проблем: 1
Было предложено улучшений: 2

Улучшенный код:
```python
def calculate_factorial(n):
    """
    Вычисляет факториал числа n.
    
    Args:
        n: Неотрицательное целое число
        
    Returns:
        Факториал числа n
        
    Raises:
        ValueError: Если n отрицательное
    """
    if n < 0:
        raise ValueError("Факториал определен только для неотрицательных чисел")
    
    result = 1
    for i in range(1, n + 1):
        result *= i
    return result
```

Чтобы увидеть подробный анализ, используйте команду /analysis
```

## Лимиты и ограничения

1. Максимальный размер кода для анализа: 4096 символов (ограничение Telegram)
2. Поддерживаемые языки программирования: Python, JavaScript, TypeScript, Java, C++, C#, PHP, Go, Rust, Ruby
3. Время анализа и улучшения кода зависит от размера и сложности кода, а также доступности Mistral API

## Решение проблем

### Проблема: Ошибка при анализе кода

**Симптом:** Бот отвечает сообщением об ошибке при выполнении команды `/analyze` или `/improve`.

**Решение:** 
1. Проверьте доступность Mistral API по адресу http://139.59.241.176:8080
2. Убедитесь, что код правильно отформатирован и окружен тройными обратными кавычками
3. Проверьте логи в файле `logs/code_improver_ui.log`

### Проблема: Низкое качество улучшений кода

**Симптом:** Предложения по улучшению кода не являются полезными или содержат ошибки.

**Решение:**
1. Попробуйте изменить параметр `temperature` в конфигурации агента
2. Предоставьте более подробный контекст при отправке кода
3. Используйте команду `/analyze` для получения более подробного анализа проблем
``` 