# Архитектура системы

## Общий обзор

Мульти-агентная система построена на основе микросервисной архитектуры, где каждый компонент является независимым сервисом с четко определенными интерфейсами и зоной ответственности.

## Ключевые компоненты

### 1. Система памяти

#### 1.1 Долгосрочная память (LongTermMemory)
- Векторное хранилище (VectorStore):
  - Интеграция с Qdrant
  - Управление эмбеддингами
  - Оптимизация поиска
- Система эмбеддингов:
  - Интеграция с Mistral
  - Кэширование векторов
  - Batch-обработка
- Прогрессивная суммаризация:
  - Многоуровневое сжатие
  - Сохранение контекста
  - Оптимизация хранения
- Оценка важности (ImportanceScorer):
  - KeywordBasedScorer: анализ по ключевым словам
  - SemanticScorer: семантическая оценка
  - Метрики и мониторинг
  - Интеграция с основной системой

#### 1.2 Поисковая система
- WebSearchProvider для поиска в интернете
- FileSearchProvider для локального поиска
- Unified Search для объединения результатов
- Система кэширования и индексации

### 2. Система автоматизации

#### 2.1 OperatorService
- Выполнение системных команд
- Управление безопасностью
- Аудит действий
- Обработка ошибок

#### 2.2 AutomationManager
- Шаблоны операций
- Планировщик действий
- Валидация команд
- Интеграция с внешними сервисами

### 3. Мульти-агентное взаимодействие

#### 3.1 AgentCommunicationProtocol
- Маршрутизация сообщений
- Управление диалогами
- Обработка конфликтов
- Синхронизация состояний

#### 3.2 AgentCoordinator
- Распределение задач
- Мониторинг выполнения
- Обработка сбоев
- Балансировка нагрузки

### 4. Интерфейсы взаимодействия

#### 4.1 Telegram-бот
- Интеграция с Telegram API
- Обработка сообщений пользователей
- Управление диалогами
- Прямое подключение к Mistral API
- Интеграция с оркестратором агентов
- Обработка ошибок и восстановление
- Мониторинг состояния

#### 4.2 Интеграция с Mistral
- MistralAdapter для взаимодействия с API:
  - Поддержка стандартного формата OpenAI API
  - Эндпоинт `/v1/chat/completions` для запросов
  - Динамическое определение доступных моделей через `/v1/models`
  - Конфигурируемые параметры генерации (temperature, top_p и др.)
  - Механизм повторных попыток при ошибках
- Система управления моделями:
  - Автоматическое определение доступных моделей
  - Валидация параметров модели
  - Конфигурация по умолчанию для каждой модели
- Асинхронная обработка запросов через httpx
- Система мониторинга здоровья:
  - Отслеживание успешных/неуспешных запросов
  - Автоматическое восстановление после сбоев
  - Метрики производительности
- Механизмы обработки ошибок:
  - Повторные попытки с экспоненциальной задержкой
  - Обработка таймаутов и сетевых ошибок
  - Логирование и диагностика проблем
- Кэширование ответов для оптимизации
- Балансировка нагрузки между экземплярами
- Поддержка потокового режима ответов
- Гибкая система конфигурации моделей

#### 4.3 Сервис моделей (Model Service)
- Унифицированное API для всех языковых моделей
- Слой адаптеров для различных моделей (Mistral, OpenAI, и др.)
- Балансировщик нагрузки между экземплярами моделей
- Система мониторинга и метрик использования моделей
- Протокол асинхронной коммуникации между агентами и моделями
- Система кэширования запросов и ответов
- Механизм отказоустойчивости и восстановления после сбоев
- Возможность горизонтального масштабирования

### 5. Мониторинг и телеметрия

#### 5.1 TelemetryService
- Интеграция OpenTelemetry
- Сбор метрик
- Трейсинг операций
- Система алертов

#### 5.2 ProcessVisualizer
- Визуализация процессов
- Анализ производительности
- Отладка агентов
- Мониторинг ресурсов

## Взаимодействие компонентов

```mermaid
graph TD
    A[Агент] --> B[AgentCoordinator]
    B --> C[OperatorService]
    B --> D[Система памяти]
    D --> E[Векторное хранилище]
    D --> F[Поисковая система]
    F --> G[WebSearch]
    F --> H[FileSearch]
    A --> I[TelemetryService]
    I --> J[OpenTelemetry]
    K[Telegram-бот] --> MS[Model Service]
    K --> B
    MS --> M[Mistral API]
    MS --> OA[OpenAI API]
    MS --> AN[Anthropic API]
    B --> MS
```

## Конфигурация портов и сервисов

### Основные сервисы
- **Mistral API (llama.cpp сервер)**
  - Адрес: `139.59.241.176:8080`
  - Основной эндпоинт: `/v1/chat/completions`
  - Health эндпоинт: `/health`
  - Модель: `TheBloke/Mistral-7B-Instruct-v0.3-GPTQ`

- **Telegram Bot**
  - Подключается к Mistral API напрямую
  - Использует порт `8080` для взаимодействия с API
  - Конфигурация в `telegram_bot/config.py`

- **Model Service**
  - Адаптер для Mistral API на порту `8080`
  - Единый интерфейс для всех языковых моделей
  - Конфигурация в `src/model_service/model_adapter/mistral_adapter.py`

- **Мониторинг**
  - Скрипт мониторинга API: проверка порта `8080`
  - Периодическая проверка health endpoint
  - Автоматический перезапуск при сбоях
  - Конфигурация в `src/utils/monitoring_script.py`

### Зависимости между сервисами
- Telegram Bot → Mistral API (порт 8080)
- Model Service → Mistral API (порт 8080)
- Monitoring Script → Mistral API (порт 8080)

## Технологический стек

### Базовые технологии
- Python 3.10+
- FastAPI
- SQLAlchemy
- Redis
- MongoDB

### AI и ML
- Mistral AI
- Qdrant
- FAISS
- Sentence Transformers

### Мониторинг
- OpenTelemetry
- Prometheus
- Grafana
- Langtrace

### Инфраструктура
- Docker
- Kubernetes
- RabbitMQ
- Nginx

## Безопасность

### Уровни безопасности
1. Аутентификация и авторизация
2. Шифрование данных
3. Аудит действий
4. Контроль доступа

### Безопасность автоматизации
1. Валидация команд
2. Изоляция процессов
3. Ограничение ресурсов
4. Логирование действий

## Масштабирование

### Горизонтальное масштабирование
- Репликация сервисов
- Шардирование данных
- Балансировка нагрузки
- Кэширование

### Вертикальное масштабирование
- Оптимизация ресурсов
- Улучшение производительности
- Асинхронная обработка
- Буферизация

## Развертывание

### Окружения
1. Development
2. Staging
3. Production

### CI/CD
- GitHub Actions
- Автоматическое тестирование
- Непрерывная интеграция
- Автоматический деплой

## Мониторинг и поддержка

### Метрики
- Производительность агентов
- Использование ресурсов
- Качество ответов
- Время отклика

### Алерты
- Критические ошибки
- Превышение лимитов
- Аномалии в работе
- Безопасность

## Дальнейшее развитие

### Приоритетные направления
1. Улучшение автономности агентов
2. Расширение возможностей поиска
3. Оптимизация производительности
4. Развитие системы мониторинга

### Исследования
1. Новые алгоритмы NLP
2. Улучшение принятия решений
3. Оптимизация памяти
4. Развитие мульти-агентного взаимодействия

## Бот-улучшатель кода (Code Improver Bot)

### Общее описание
Бот-улучшатель кода - это специализированный агент системы, предназначенный для анализа и улучшения исходного кода. Он интегрируется с Telegram через специальный интерфейс и использует Mistral API для генерации предложений по улучшению кода.

### Компоненты системы

#### 1. Агент улучшения кода (CodeImprovementAgent)
- **Назначение**: Анализ кода и генерация улучшений
- **Расположение**: `src/agents/code_improvement_agent.py`
- **Ключевые функции**:
  - Анализ исходного кода различных языков программирования
  - Выявление потенциальных проблем и недостатков
  - Генерация предложений по улучшению кода
  - Оценка сложности и поддерживаемости кода
  - Применение улучшений с проверкой безопасности

#### 2. Анализатор кода (CodeAnalyzer)
- **Назначение**: Статический анализ кода
- **Расположение**: `src/agents/code_analyzer.py`
- **Ключевые функции**:
  - Парсинг и синтаксический анализ кода
  - Обнаружение паттернов и антипаттернов
  - Вычисление метрик качества кода
  - Категоризация проблем по типам и приоритетам

#### 3. Трансформатор кода (CodeTransformer)
- **Назначение**: Безопасная модификация кода
- **Расположение**: `src/agents/code_transformer.py`
- **Ключевые функции**:
  - Рефакторинг кода с сохранением функциональности
  - Валидация изменений перед применением
  - Поддержка отката изменений при ошибках
  - Форматирование кода согласно стандартам

#### 4. Отслеживание улучшений (ImprovementTracker) - в разработке
- **Назначение**: Отслеживание и оценка примененных улучшений
- **Расположение**: `src/agents/improvement_tracker.py` (планируется)
- **Ключевые функции**:
  - Хранение истории изменений
  - Сравнение версий кода до и после улучшений
  - Оценка эффективности улучшений
  - Сбор метрик для анализа

#### 5. Telegram-интерфейс (CodeImproverUI)
- **Назначение**: Взаимодействие с пользователем через Telegram
- **Расположение**: `telegram_bot/code_improver_ui.py`
- **Ключевые функции**:
  - Обработка команд для анализа и улучшения кода
  - Форматированное отображение результатов
  - Интерактивные элементы для управления процессом
  - Визуализация разницы между версиями кода

### Взаимодействие с другими компонентами системы

#### Интеграция с Mistral API
- Агент улучшения кода использует Mistral API для генерации предложений по улучшению
- Запросы обрабатываются через MistralAdapter 
- Результаты генерации оптимизируются и форматируются для представления пользователю

#### Интеграция с системой памяти
- История взаимодействия с пользователем сохраняется в системе памяти
- Контекст предыдущих улучшений используется для более точных предложений
- Долгосрочная память позволяет учитывать стиль и предпочтения пользователя

#### Интеграция с инфраструктурой
- Бот запускается и контролируется через специальные скрипты
- Мониторинг работы бота обеспечивает стабильность функционирования
- Система автоматического восстановления после сбоев гарантирует непрерывную работу

### Диаграмма взаимодействия компонентов
```
Пользователь (Telegram) <-> CodeImproverUI <-> CodeImprovementAgent <-> Mistral API
                                                      |
                                                      v
                                    CodeAnalyzer <-> CodeTransformer
                                                      |
                                                      v
                                              ImprovementTracker
                                                      |
                                                      v
                                          Система памяти и логирования
```

### Процесс обработки запроса пользователя
1. Пользователь отправляет код через Telegram-бот
2. CodeImproverUI обрабатывает запрос и передает код агенту
3. CodeImprovementAgent анализирует код с помощью CodeAnalyzer
4. Результаты анализа используются для генерации запроса к Mistral API
5. Полученные предложения по улучшению проверяются и применяются через CodeTransformer
6. История изменений сохраняется в ImprovementTracker
7. Результаты форматируются и отправляются пользователю через CodeImproverUI 