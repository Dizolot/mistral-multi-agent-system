# Система непрерывного улучшения кода

## Обзор

Система непрерывного улучшения кода - это мульти-агентная система, которая автоматически анализирует, улучшает, тестирует и оценивает код. Система работает круглосуточно, выполняя циклы улучшения с заданным интервалом и автоматически перезапускается при сбоях.

Основная цель системы - постоянное совершенствование кодовой базы без участия человека через итеративный процесс анализа, улучшения, тестирования и оценки.

## Архитектура системы

Система построена на основе микросервисной архитектуры и состоит из следующих компонентов:

1. **Оркестратор агентов (AgentOrchestrator)** - центральный компонент, управляющий жизненным циклом агентов и координирующий их работу.
   - Распределяет задачи между агентами
   - Контролирует статус выполнения задач
   - Обеспечивает восстановление после сбоев
   - Запускает циклы непрерывного улучшения кода

2. **Специализированные агенты**:
   - **CodeAnalyzerAgent** - анализирует код и выявляет возможные улучшения
     - Выполняет статический анализ кода
     - Определяет проблемные области и возможности для оптимизации
     - Формирует отчет с рекомендациями по улучшению

   - **CodeImproverAgent** - вносит улучшения на основе анализа
     - Генерирует изменения в коде на основе рекомендаций CodeAnalyzerAgent
     - Применяет лучшие практики разработки
     - Поддерживает различные стратегии улучшения (производительность, читаемость, тестируемость)

   - **TestingAgent** - тестирует внесенные изменения
     - Запускает модульные и интеграционные тесты
     - Проверяет регрессию функциональности
     - Формирует отчет о результатах тестирования

   - **EvaluationAgent** - оценивает качество изменений и принимает решение о их применении
     - Анализирует результаты тестов
     - Оценивает качество кода по различным метрикам
     - Принимает решение о применении или отклонении изменений

3. **Сервис моделей (ModelService)** - обеспечивает взаимодействие с языковыми моделями через унифицированный интерфейс
   - Предоставляет единый API для работы с различными моделями
   - Обеспечивает балансировку нагрузки и кэширование запросов
   - Управляет сессиями и контекстом взаимодействия
   - Взаимодействует с Mistral API на сервере по адресу http://139.59.241.176:8080

4. **Система памяти (MemoryManager)** - управляет контекстом и историей взаимодействий агентов
   - Хранит краткосрочную и долгосрочную память агентов
   - Обеспечивает обмен информацией между агентами
   - Поддерживает сериализацию и десериализацию контекста

5. **Служба мониторинга** - отслеживает состояние системы и автоматически перезапускает ее при сбоях
   - Проверяет доступность Mistral API
   - Отслеживает статус процессов
   - Перезапускает службы при сбоях
   - Отправляет уведомления о состоянии системы

## Взаимодействие компонентов

Процесс непрерывного улучшения кода включает следующие этапы:

1. **Запуск цикла** - AgentOrchestrator инициирует цикл улучшения кода
2. **Анализ** - CodeAnalyzerAgent анализирует целевую директорию и выявляет возможные улучшения
3. **Улучшение** - CodeImproverAgent генерирует и применяет изменения к коду
4. **Тестирование** - TestingAgent запускает тесты для проверки функциональности
5. **Оценка** - EvaluationAgent оценивает качество изменений и принимает решение о их применении
6. **Применение** - Успешные изменения сохраняются и могут быть отправлены в репозиторий
7. **Повторение** - Цикл повторяется с заданным интервалом

## Запуск системы

### Предварительные требования

1. Python 3.9+ с установленными зависимостями из `requirements.txt`
2. Доступ к Mistral API (по умолчанию: http://139.59.241.176:8080)
3. Настроенные переменные окружения (опционально):
   - `MISTRAL_API_URL` - URL для доступа к Mistral API
   - `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID` - для отправки уведомлений в Telegram
   - `PYTHONPATH` - путь к корневой директории проекта

### Запуск службы

#### Проверка мониторинга API

Перед запуском службы убедитесь, что мониторинг API запущен:

```bash
./scripts/run_monitoring.sh
```

Проверьте логи мониторинга:

```bash
tail -f logs/monitoring.log
```

#### Запуск службы непрерывного улучшения

Для запуска службы непрерывного улучшения кода выполните:

```bash
./scripts/run_continuous_improvement_service.sh
```

Это запустит службу в фоновом режиме с автоматическим перезапуском при сбоях. По умолчанию система будет анализировать и улучшать код в директории `multi_agent_system/agents` с интервалом в 1 час.

### Остановка службы

Для остановки службы выполните:

```bash
./scripts/stop_continuous_improvement_service.sh
```

Для остановки мониторинга API:

```bash
./scripts/stop_monitoring.sh
```

### Настройка параметров

Вы можете настроить параметры службы, отредактировав скрипт `scripts/run_continuous_improvement_service.sh`:

- `INTERVAL` - интервал между циклами улучшения в секундах (по умолчанию: 3600)
- `TARGET_DIR` - директория с целевым кодом для улучшения
- `EXTENSIONS` - расширения файлов для анализа (через запятую)
- `EXCLUDE` - исключенные директории (через запятую)
- `MAX_RESTART_ATTEMPTS` - максимальное количество попыток перезапуска за день
- `RESTART_COOLDOWN` - задержка между попытками перезапуска (в секундах)

## Мониторинг и логирование

### Структура логов

Система создает следующие логи в директории `logs`:

- `continuous_improvement.log` - основной лог работы системы
- `service_status.log` - лог статуса службы
- `monitor.log` - лог мониторинга и перезапусков
- `notifications.log` - лог отправленных уведомлений
- `monitoring.log` - лог мониторинга API Mistral
- `agent_orchestrator.log` - лог оркестратора агентов
- `*_agent_*.log` - логи отдельных агентов

### Команды для мониторинга

Для мониторинга работы системы используйте следующие команды:

```bash
# Просмотр основного лога системы
tail -f logs/continuous_improvement.log

# Проверка статуса API
tail -f logs/monitoring.log

# Проверка статуса службы
tail -f logs/service_status.log

# Проверка логов мониторинга и перезапусков
tail -f logs/monitor.log

# Просмотр логов оркестратора
tail -f logs/agent_orchestrator.log
```

## Интеграция с GitHub

Система поддерживает интеграцию с GitHub для автоматической отправки улучшений в репозиторий.

### Настройка интеграции

1. Создайте токен доступа к GitHub с правами на запись в репозиторий
2. Добавьте токен в переменные окружения:

```bash
export GITHUB_TOKEN="ваш_токен"
export GITHUB_REPO="пользователь/репозиторий"
```

### Автоматическая отправка изменений

После успешного применения улучшений EvaluationAgent может автоматически создать коммит и отправить изменения в репозиторий. Для включения этой функциональности добавьте следующий параметр в конфигурацию EvaluationAgent:

```python
evaluation_agent = EvaluationAgent(
    agent_id="evaluation_agent_1",
    model_service=model_service,
    memory_manager=memory_manager,
    config={
        "quality_threshold": 0.7,
        "max_evaluation_time": 120,
        "auto_commit": True,
        "github_integration": True
    }
)
```

## Уведомления

Система может отправлять уведомления о своем состоянии в Telegram. Для настройки уведомлений добавьте следующие переменные окружения в скрипт запуска:

```bash
export TELEGRAM_BOT_TOKEN="ваш_токен"
export TELEGRAM_CHAT_ID="ваш_чат_id"
```

Типы отправляемых уведомлений:
- Запуск и остановка службы
- Перезапуск службы при сбоях
- Достижение лимита перезапусков
- Успешное применение улучшений кода
- Ошибки в работе системы

## Расширение системы

### Добавление новых агентов

Для добавления нового агента:

1. Создайте класс агента, наследующийся от `BaseAgent`
2. Реализуйте необходимые методы (`analyze`, `process`, `evaluate` и т.д.)
3. Зарегистрируйте агента в оркестраторе в функции `setup_orchestrator` в файле `run_continuous_improvement.py`

Пример создания нового агента:

```python
from multi_agent_system.agents.base_agent import BaseAgent

class MyCustomAgent(BaseAgent):
    def __init__(self, agent_id, model_service, memory_manager, config=None):
        super().__init__(agent_id, model_service, memory_manager, config)
        # Дополнительная инициализация
    
    async def analyze(self, data):
        # Реализация анализа
        return result
    
    async def process(self, data):
        # Реализация обработки
        return result
```

### Настройка стратегий улучшения

Вы можете настроить стратегии улучшения кода, изменив параметры конфигурации агентов в функции `setup_orchestrator` в файле `run_continuous_improvement.py`.

Доступные стратегии улучшения:
- `maintainability` - улучшение поддерживаемости кода
- `performance` - оптимизация производительности
- `readability` - улучшение читаемости кода
- `security` - устранение уязвимостей безопасности
- `best_practices` - применение лучших практик разработки

## Устранение неполадок

### Служба не запускается

1. Проверьте доступность Mistral API: `curl http://139.59.241.176:8080/v1/models`
2. Проверьте логи в директории `logs`
3. Убедитесь, что все зависимости установлены: `pip install -r requirements.txt`
4. Проверьте, что все необходимые модули присутствуют в системе: `python check_system.py`
5. Убедитесь, что переменная окружения `PYTHONPATH` установлена корректно

### Служба запускается, но не улучшает код

1. Проверьте, что директория с целевым кодом существует и содержит файлы с указанными расширениями
2. Проверьте логи в файле `logs/continuous_improvement.log`
3. Убедитесь, что все агенты зарегистрированы и работают корректно
4. Проверьте, что доступ к API Mistral работает стабильно

### Служба часто перезапускается

1. Проверьте доступность Mistral API
2. Проверьте логи на наличие ошибок
3. Увеличьте значение `RESTART_COOLDOWN` для увеличения интервала между попытками перезапуска
4. Убедитесь, что сервер имеет достаточно ресурсов для работы системы

### Проблемы с интеграцией GitHub

1. Убедитесь, что токен доступа к GitHub имеет необходимые права
2. Проверьте, что указаны корректные переменные окружения
3. Убедитесь, что репозиторий доступен и имеет правильную структуру

## Дальнейшее развитие

### Планируемые улучшения

1. Интеграция с векторным хранилищем для семантического поиска
2. Реализация управления забыванием неактуальной информации
3. Улучшение генерации предложений по улучшению кода с контекстной информацией
4. Добавление механизма контроля качества изменений
5. Оптимизация производительности цикла улучшения

### Перспективные направления

1. Расширение набора инструментов для агентов (поиск в интернете, работа с документами)
2. Добавление поддержки сравнительного анализа нескольких репозиториев
3. Создание панели управления для мониторинга и настройки системы
4. Расширение функциональности агентов для работы с различными языками программирования
5. Интеграция с системами CI/CD для автоматического деплоя изменений 